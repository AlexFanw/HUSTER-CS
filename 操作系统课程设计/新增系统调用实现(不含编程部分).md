### æ–°å¢ç³»ç»Ÿè°ƒç”¨å®ç°

**ä»¥ä¸‹å†…å®¹åŸºäºUbuntu19.10 + å†…æ ¸Linux5.4.21,å¦‚æœæ˜¯4.x.xç‰ˆæœ¬çš„å†…æ ¸,å‚è€ƒä»¥ä¸‹ä¸‹æ–‡é“¾æ¥**
ğŸ‘‰[åŸºäºLinux4ä»£å†…æ ¸çš„æ–°å¢ç³»ç»Ÿè°ƒç”¨æ­¥éª¤](https://blog.csdn.net/qq_41175905/article/details/80529245)

**1.é…ç½®è™šæ‹Ÿæœº**
[Vmwareå®‰è£…è™šæ‹ŸæœºUbuntuçŸ¥ä¹æ•™ç¨‹é“¾æ¥ğŸ”—](https://zhuanlan.zhihu.com/p/38797088)
[VMwareè™šæ‹Ÿæœºæ‰©å±•Ubuntuç³»ç»Ÿç£ç›˜ç©ºé—´æ•™ç¨‹ğŸ”—](https://blog.csdn.net/daemon_2017/article/details/80660372)



**2.æ›´æ¢Ubuntuæºä¸ºæ¸…åæº**
[æ›´æ¢é•œåƒæºé“¾æ¥ğŸ”—](https://blog.csdn.net/yumei1998/article/details/83214433)
æ³¨æ„ä½ çš„Ubuntuç‰ˆæœ¬,é€‰æ‹©é€‚é…çš„é•œåƒæº,å¯åŠ å¿«å®‰è£…åŒ…çš„é€Ÿåº¦.



**3.ä¸€é”®é…ç½®æ‰€æœ‰æ‰€éœ€è¦çš„åŒ…**
æ¢å¥½é•œåƒæºåç›´æ¥åœ¨å‘½ä»¤è¡Œé‡Œé…ç½®å°±è¡Œäº†.

```
apt-get install libncurses-dev flex bison openssl libssl-dev dkms libelf-dev libudev-dev libpci-dev libiberty-dev autoconf
```
åç»­å¦‚æœç¼ºå…¶ä»–åŒ…å°±å®‰è£…ç³»ç»Ÿæç¤ºä¸‹è½½å°±å¥½äº†



**4.å†…æ ¸ä¸‹è½½**
åˆ«å»www.kernel.orgä¸‹äº†,é€Ÿåº¦å®åœ¨ä¸å¿ç›´è§†
ç›´æ¥é€šè¿‡ä¸‹è¿°é“¾æ¥ä¸‹è½½é…ç½®.
[kernelé•œåƒæºé“¾æ¥ğŸ”—](http://ftp.sjtu.edu.cn/sites/ftp.kernel.org/pub/linux/kernel/)
é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬æŒ‘ä¸€ä¸ªä¸‹è½½å³å¯.



**5.å®‰è£…å†…æ ¸**

- ctrl+alt+tå¿«é€Ÿæ‰“å¼€CMD,å¹¶ä¸”è¾“å…¥sudo suè·å¾—ç®¡ç†å‘˜æƒé™.
- å°†ä¸‹è½½å¥½çš„å†…æ ¸moveåˆ°/usr/srcç›®å½•ä¸‹,ä½¿ç”¨å‘½ä»¤

```
sudo mv **/**/**/linux***  /usr/src/
//**ä»£è¡¨ä½ åˆšä¸‹è½½çš„linuxå†…æ ¸çš„è·¯å¾„
```
- è¿›å…¥/usr/src/ è§£å‹æ–‡ä»¶

```
sudo tar -xvf  linux****
//linux***ä»£è¡¨ä½ åˆšä¸‹è½½çš„linuxå†…æ ¸çš„æ–‡ä»¶å,å¯ä»¥ç”¨tabè‡ªåŠ¨è¡¥é½.
```

- è¿›å…¥è§£å‹å‡ºæ¥çš„å†…æ ¸æ–‡ä»¶ä¸­çš„kernelç›®å½•

```
cd linux***/kernel
```

- ä¿®æ”¹sys.cæ–‡ä»¶

```
sudo gedit sys.c
//åœ¨æœ€æœ«å°¾åŠ ä¸Šä½ æƒ³åŠ çš„æ–°çš„ç³»ç»Ÿè°ƒç”¨
//ä¸¾ä¸ªä¾‹å­,helloworldç¨‹åº
SYSCALL_DEFINE1(helloworld,int,number){
        printk("Hello,world!");
        return number+1
}
//å¯¹ç³»ç»Ÿè°ƒç”¨çš„ç¼–å†™ æ³¨æ„æ­¤å¤„ä¸å‰ç‰ˆæœ¬å†…æ ¸çš„ä¸åŒ
//ä¸Šè¿°ç¨‹åºä¸­,1ä»£è¡¨è¿™ä¸ªå‡½æ•°åªæœ‰ä¸€ä¸ªå‚æ•°,æœ‰ä¸¤ä¸ªå‚æ•°å°±æ¢æˆ2
//helloworldæ˜¯æ–°å¢ç³»ç»Ÿè°ƒç”¨å‡½æ•°å
//intæ˜¯å‚æ•°ç±»å‹,numberæ˜¯å½¢å‚.
//å‡½æ•°åŠŸèƒ½å°±æ˜¯æ‰“å°Hello,world!,å¹¶ä¸”è¿”å›1+number.å¯ä»¥é€šè¿‡dmesgçœ‹åˆ°æ‰“å°çš„å¥å­.
```

- å¢åŠ ç³»ç»Ÿè°ƒç”¨å·

```
//ä»kernelè¿”å›ä¸Šä¸€çº§ç›®å½•
cd /arch/x86/entry/syscalls
sudo gedit syscall_64.tbl
//å¢åŠ ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨
//ä¾‹å¦‚ 335    64  helloworld      __x64_sys_helloworld
```

- å¢åŠ ç³»ç»Ÿè°ƒç”¨å¤´æ–‡ä»¶

```
//è¿”å›/usr/src/linux***ç›®å½•
cd include/linux
sudo gedit syscalls.h
//ä¾‹å¦‚asmlinkage long sys_helloworld(int number);
```
- æœ€åæŒ‰ç…§ä¸Šè¿°æ­¥éª¤ç¼–å†™ä½ çš„æ–‡ä»¶copyå’ŒPã€Væ“ä½œç³»ç»Ÿè°ƒç”¨ç¨‹åºå§



**6.ç¼–è¯‘å†…æ ¸**

```
sudo make mrproper //åˆ é™¤ä¹‹å‰ç¼–è¯‘çš„æ®‹ä½™æ–‡ä»¶.åªåœ¨ç¬¬ä¸€æ¬¡ç¼–è¯‘æ—¶æ‰§è¡Œå³å¯,ä»¥å…æ¯æ¬¡ç¼–è¯‘æŠŠé‡å¤æ–‡ä»¶é‡å¤ç¼–è¯‘.
sudo make clean //å¯æ‰§è¡Œå¯ä¸æ‰§è¡Œ,å› ä¸ºä¸Šä¸€ä¸ªå‘½ä»¤ä¼¼ä¹æ˜¯æ¶µç›–äº†cleançš„
sudo make menuconfig//åœ¨general setupå“ªé‡Œç»™ä½ çš„å†…æ ¸æ¢ä¸ªåå­—,æ¯”å¦‚AlexKernel
sudo make -j4 //æ ¹æ®ä½ ç»™è™šæ‹Ÿæœºåˆ†é…çš„æ ¸å¿ƒæ•°æ¥é€‚é….æˆ‘åˆ†äº†4æ ¸å¿ƒ.
sudo make modules_install // å®‰è£…å†…æ ¸æ¨¡å—
sudo make install //å®‰è£…å†…æ ¸
```

**7.æ›´æ¢ç³»ç»Ÿé»˜è®¤å¯åŠ¨å†…æ ¸**
[æ›´æ¢å¯åŠ¨å†…æ ¸é“¾æ¥ğŸ”—](https://blog.csdn.net/cf_wu95/article/details/85984956)



**8.é‡å¯,ç¼–å†™ä½ çš„æµ‹è¯•cæ–‡ä»¶.**



(PS:ä¸å«Œéº»çƒ¦çš„å¯ä»¥ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£ã€‚[æ–°å¢ç³»ç»Ÿè°ƒç”¨æ–¹æ³•å®˜æ–¹æ–‡æ¡£](https://www.kernel.org/doc/html/latest/process/adding-syscalls.html))

